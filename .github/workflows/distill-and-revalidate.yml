# name: Distill & Revalidate DApp Data

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - "data/apps/**/meta.json"
#       - "scripts/distill.ts"
#       - "scripts/check-links.ts"
#       - "lib/cloudinary.ts"
#       - "lib/schema.ts"
#       - "lib/logger.ts"
#   workflow_dispatch:

# permissions:
#   contents: write

# jobs:
#   distill_and_commit:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4
#         with:
#           token: ${{ secrets.GITHUB_TOKEN }}

#       - name: Setup pnpm
#         uses: pnpm/action-setup@v3
#         with:
#           version: 8
#           run_install: true

#       - name: Load Environment Variables
#         run: |
#           echo "CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}" >> $GITHUB_ENV
#           echo "CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}" >> $GITHUB_ENV
#           echo "CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}" >> $GITHUB_ENV
#           echo "HMAC_SECRET=${{ secrets.HMAC_SECRET }}" >> $GITHUB_ENV

#       - name: Run DApp Data Distillation
#         run: pnpm run distill

#       - name: Run DApp Data Link Accessibility Check
#         run: pnpm run check-links

#       - name: Auto-commit generated files
#         uses: stefanzweifel/git-auto-commit-action@v5
#         with:
#           commit_message: "chore(data): auto-generated DApp data files"
#           file_pattern: |
#             data/apps.min.json
#             data/slugs.json
#             data/apps/**/meta.json
name: Validate DApp Data

on:
  pull_request:
    branches:
      - main
    paths:
      - "data/apps/**"
      - "scripts/**"
      - "lib/**"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
          run_install: true

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: "data/apps/**/meta.json"

      - name: Extract changed dapp slugs
        id: get_changed_dapp_slugs
        run: |
          SLUGS=()
          for file in ${{ steps.changed-files.outputs.modified_files }} ${{ steps.changed-files.outputs.added_files }}; do
            slug=$(echo "$file" | sed -E 's|data/apps/([^/]+)/meta.json|\1|')
            if [[ "$slug" != "$file" ]]; then
              SLUGS+=("$slug")
            fi
          done

          UNIQUE_SLUGS=$(printf "%s\n" "${SLUGS[@]}" | sort -u | tr '\n' ' ' | xargs)
          echo "Found changed slugs: $UNIQUE_SLUGS"
          echo "slugs=$UNIQUE_SLUGS" >> $GITHUB_OUTPUT
        shell: bash

      - name: Run DApp Data Validation
        run: pnpm run validate

      - name: Run DApp Data Link Accessibility Check
        if: steps.get_changed_dapp_slugs.outputs.slugs != ''
        run: |
          SLUGS="${{ steps.get_changed_dapp_slugs.outputs.slugs }}"
          if [ -n "$SLUGS" ]; then
            pnpm run check-links $SLUGS
          fi

      # ðŸ”½ AUTO-MERGE STEP (comment out when testing)
      - name: Enable auto-merge
        if: success()
        run: gh pr merge --auto --squash "${{ github.event.pull_request.number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
